BEGIN;

CREATE TABLE alembic_version (
    version_num VARCHAR(32) NOT NULL, 
    CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num)
);

-- Running upgrade  -> df0bbc52c089

CREATE TABLE expense_categories (
    id SERIAL NOT NULL, 
    name VARCHAR NOT NULL, 
    icon VARCHAR, 
    PRIMARY KEY (id)
);

COMMENT ON COLUMN expense_categories.name IS '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ''–ï–¥–∞'')';

COMMENT ON COLUMN expense_categories.icon IS '–ò–∫–æ–Ω–∫–∞ –∏–ª–∏ emoji –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ''üçï'' –∏–ª–∏ ''food'')';

CREATE INDEX ix_expense_categories_id ON expense_categories (id);

CREATE TABLE users (
    id SERIAL NOT NULL, 
    telegram_id INTEGER NOT NULL, 
    username VARCHAR, 
    first_name VARCHAR, 
    last_name VARCHAR, 
    name VARCHAR, 
    photo_url VARCHAR, 
    language_code VARCHAR(8), 
    allows_write_to_pm BOOLEAN, 
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    PRIMARY KEY (id)
);

CREATE INDEX ix_users_id ON users (id);

CREATE INDEX ix_users_name ON users (name);

CREATE UNIQUE INDEX ix_users_telegram_id ON users (telegram_id);

CREATE INDEX ix_users_username ON users (username);

CREATE TABLE friends (
    id SERIAL NOT NULL, 
    user_id INTEGER NOT NULL, 
    friend_id INTEGER NOT NULL, 
    status VARCHAR NOT NULL, 
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    PRIMARY KEY (id), 
    FOREIGN KEY(friend_id) REFERENCES users (id) ON DELETE CASCADE, 
    FOREIGN KEY(user_id) REFERENCES users (id) ON DELETE CASCADE, 
    CONSTRAINT _user_friend_uc UNIQUE (user_id, friend_id)
);

CREATE INDEX ix_friends_id ON friends (id);

CREATE TABLE groups (
    id SERIAL NOT NULL, 
    name VARCHAR, 
    description VARCHAR, 
    owner_id INTEGER, 
    PRIMARY KEY (id), 
    FOREIGN KEY(owner_id) REFERENCES users (id)
);

CREATE INDEX ix_groups_id ON groups (id);

CREATE INDEX ix_groups_name ON groups (name);

CREATE TABLE group_members (
    id SERIAL NOT NULL, 
    group_id INTEGER, 
    user_id INTEGER, 
    PRIMARY KEY (id), 
    FOREIGN KEY(group_id) REFERENCES groups (id), 
    FOREIGN KEY(user_id) REFERENCES users (id)
);

CREATE INDEX ix_group_members_id ON group_members (id);

CREATE TABLE transactions (
    id SERIAL NOT NULL, 
    group_id INTEGER NOT NULL, 
    created_by INTEGER NOT NULL, 
    type VARCHAR NOT NULL, 
    amount FLOAT NOT NULL, 
    date TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    comment VARCHAR, 
    category_id INTEGER, 
    paid_by INTEGER, 
    split_type VARCHAR, 
    transfer_from INTEGER, 
    transfer_to JSON, 
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    updated_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    currency VARCHAR, 
    is_deleted BOOLEAN, 
    receipt_url VARCHAR, 
    receipt_data JSON, 
    PRIMARY KEY (id), 
    FOREIGN KEY(category_id) REFERENCES expense_categories (id), 
    FOREIGN KEY(created_by) REFERENCES users (id), 
    FOREIGN KEY(group_id) REFERENCES groups (id), 
    FOREIGN KEY(paid_by) REFERENCES users (id), 
    FOREIGN KEY(transfer_from) REFERENCES users (id)
);

COMMENT ON COLUMN transactions.group_id IS 'ID –≥—Ä—É–ø–ø—ã, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è';

COMMENT ON COLUMN transactions.created_by IS '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–∑–¥–∞–≤—à–∏–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é';

COMMENT ON COLUMN transactions.type IS '''expense'' ‚Äî —Ä–∞—Å—Ö–æ–¥, ''transfer'' ‚Äî –ø–µ—Ä–µ–≤–æ–¥ (—Ç—Ä–∞–Ω—à)';

COMMENT ON COLUMN transactions.amount IS '–°—É–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏';

COMMENT ON COLUMN transactions.date IS '–î–∞—Ç–∞ —Ä–∞—Å—Ö–æ–¥–∞/—Ç—Ä–∞–Ω—à–∞';

COMMENT ON COLUMN transactions.comment IS '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ';

COMMENT ON COLUMN transactions.category_id IS '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è type=''expense'')';

COMMENT ON COLUMN transactions.paid_by IS '–ö—Ç–æ –æ–ø–ª–∞—Ç–∏–ª (–¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤)';

COMMENT ON COLUMN transactions.split_type IS '–¢–∏–ø –¥–µ–ª–µ–Ω–∏—è (''equal'', ''shares'', ''custom'')';

COMMENT ON COLUMN transactions.transfer_from IS '–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –¥–µ–Ω–µ–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è type=''transfer'')';

COMMENT ON COLUMN transactions.transfer_to IS '–°–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (user_id), –¥–ª—è transfer ‚Äî –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ, JSON-–º–∞—Å—Å–∏–≤';

COMMENT ON COLUMN transactions.created_at IS '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è';

COMMENT ON COLUMN transactions.updated_at IS '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è';

COMMENT ON COLUMN transactions.currency IS '–í–∞–ª—é—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RUB';

COMMENT ON COLUMN transactions.is_deleted IS '–ü—Ä–∏–∑–Ω–∞–∫ soft delete (–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è)';

COMMENT ON COLUMN transactions.receipt_url IS '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª —á–µ–∫–∞ (–µ—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω)';

COMMENT ON COLUMN transactions.receipt_data IS '–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —á–µ–∫–∞ (–º–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤, –∏—Ç–æ–≥ –∏ —Ç.–¥.)';

CREATE INDEX ix_transactions_id ON transactions (id);

CREATE TABLE transaction_shares (
    id SERIAL NOT NULL, 
    transaction_id INTEGER NOT NULL, 
    user_id INTEGER NOT NULL, 
    amount FLOAT NOT NULL, 
    shares INTEGER, 
    PRIMARY KEY (id), 
    FOREIGN KEY(transaction_id) REFERENCES transactions (id) ON DELETE CASCADE, 
    FOREIGN KEY(user_id) REFERENCES users (id)
);

COMMENT ON COLUMN transaction_shares.transaction_id IS 'ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏';

COMMENT ON COLUMN transaction_shares.user_id IS '–£—á–∞—Å—Ç–Ω–∏–∫ –≥—Ä—É–ø–ø—ã';

COMMENT ON COLUMN transaction_shares.amount IS '–°—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –¥–æ–ª–∂–µ–Ω —ç—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫';

COMMENT ON COLUMN transaction_shares.shares IS '–ö–æ–ª-–≤–æ –¥–æ–ª–µ–π (–µ—Å–ª–∏ split_type=''shares'')';

CREATE INDEX ix_transaction_shares_id ON transaction_shares (id);

INSERT INTO alembic_version (version_num) VALUES ('df0bbc52c089') RETURNING alembic_version.version_num;

-- Running upgrade df0bbc52c089 -> 6bb6e9e433e7

ALTER TABLE users ALTER COLUMN telegram_id TYPE BIGINT;

UPDATE alembic_version SET version_num='6bb6e9e433e7' WHERE alembic_version.version_num = 'df0bbc52c089';

-- Running upgrade 6bb6e9e433e7 -> 2cc12f3469b7

ALTER TABLE users ADD COLUMN is_pro BOOLEAN DEFAULT FALSE NOT NULL;

ALTER TABLE users ADD COLUMN invited_friends_count INTEGER DEFAULT '0' NOT NULL;

ALTER TABLE friends DROP COLUMN status;

UPDATE alembic_version SET version_num='2cc12f3469b7' WHERE alembic_version.version_num = '6bb6e9e433e7';

-- Running upgrade 2cc12f3469b7 -> fcab50bc945c

CREATE TABLE friend_invites (
    id SERIAL NOT NULL, 
    from_user_id INTEGER NOT NULL, 
    token VARCHAR NOT NULL, 
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    PRIMARY KEY (id), 
    FOREIGN KEY(from_user_id) REFERENCES users (id)
);

CREATE INDEX ix_friend_invites_id ON friend_invites (id);

CREATE UNIQUE INDEX ix_friend_invites_token ON friend_invites (token);

CREATE TABLE events (
    id SERIAL NOT NULL, 
    actor_id INTEGER NOT NULL, 
    target_user_id INTEGER, 
    group_id INTEGER, 
    type VARCHAR NOT NULL, 
    data JSON, 
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    PRIMARY KEY (id), 
    FOREIGN KEY(actor_id) REFERENCES users (id), 
    FOREIGN KEY(group_id) REFERENCES groups (id), 
    FOREIGN KEY(target_user_id) REFERENCES users (id)
);

CREATE TABLE invite_usages (
    id SERIAL NOT NULL, 
    invite_id INTEGER NOT NULL, 
    user_id INTEGER NOT NULL, 
    used_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    PRIMARY KEY (id), 
    FOREIGN KEY(invite_id) REFERENCES friend_invites (id), 
    FOREIGN KEY(user_id) REFERENCES users (id)
);

ALTER TABLE friends ADD COLUMN hidden BOOLEAN;

ALTER TABLE users ALTER COLUMN is_pro DROP DEFAULT;

COMMENT ON COLUMN users.is_pro IS '–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å PRO';

ALTER TABLE users ALTER COLUMN invited_friends_count DROP DEFAULT;

COMMENT ON COLUMN users.invited_friends_count IS '–°–∫–æ–ª—å–∫–æ –¥—Ä—É–∑–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ –∏–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–µ';

UPDATE alembic_version SET version_num='fcab50bc945c' WHERE alembic_version.version_num = '2cc12f3469b7';

-- Running upgrade fcab50bc945c -> 7b08661241e1

CREATE TABLE group_invites (
    id SERIAL NOT NULL, 
    group_id INTEGER NOT NULL, 
    token VARCHAR NOT NULL, 
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL, 
    PRIMARY KEY (id), 
    FOREIGN KEY(group_id) REFERENCES groups (id)
);

CREATE INDEX ix_group_invites_id ON group_invites (id);

CREATE UNIQUE INDEX ix_group_invites_token ON group_invites (token);

UPDATE alembic_version SET version_num='7b08661241e1' WHERE alembic_version.version_num = 'fcab50bc945c';

-- Running upgrade 7b08661241e1 -> 2025_08_08_groups_v2

CREATE TYPE group_status AS ENUM ('active', 'archived');

ALTER TABLE groups ADD COLUMN status group_status DEFAULT 'active' NOT NULL;

ALTER TABLE groups ADD COLUMN archived_at TIMESTAMP WITH TIME ZONE;

ALTER TABLE groups ADD COLUMN deleted_at TIMESTAMP WITH TIME ZONE;

ALTER TABLE groups ADD COLUMN end_date DATE;

ALTER TABLE groups ADD COLUMN auto_archive BOOLEAN DEFAULT false NOT NULL;

ALTER TABLE groups ADD COLUMN default_currency_code VARCHAR(3) DEFAULT 'RUB' NOT NULL;

UPDATE groups SET default_currency_code = 'RUB' WHERE default_currency_code IS NULL;;

CREATE TABLE currencies (
    code VARCHAR(3) NOT NULL, 
    numeric_code SMALLINT NOT NULL, 
    decimals SMALLINT NOT NULL, 
    symbol VARCHAR(8), 
    flag_emoji VARCHAR(8), 
    display_country VARCHAR(2), 
    name_i18n JSONB NOT NULL, 
    is_popular BOOLEAN DEFAULT false NOT NULL, 
    is_active BOOLEAN DEFAULT true NOT NULL, 
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL, 
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL, 
    PRIMARY KEY (code)
);

COMMENT ON COLUMN currencies.code IS '–ö–æ–¥ –≤–∞–ª—é—Ç—ã ISO-4217, –Ω–∞–ø—Ä. ''USD''';

COMMENT ON COLUMN currencies.numeric_code IS '–ß–∏—Å–ª–æ–≤–æ–π –∫–æ–¥ ISO-4217';

COMMENT ON COLUMN currencies.decimals IS '–ö–æ–ª-–≤–æ –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π';

COMMENT ON COLUMN currencies.symbol IS '–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã';

COMMENT ON COLUMN currencies.flag_emoji IS '–≠–º–æ–¥–∑–∏ —Ñ–ª–∞–≥–∞';

COMMENT ON COLUMN currencies.display_country IS 'ISO-3166 –∫–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';

COMMENT ON COLUMN currencies.name_i18n IS '–õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è';

ALTER TABLE currencies ADD CONSTRAINT uq_currencies_numeric_code UNIQUE (numeric_code);

CREATE INDEX ix_currencies_is_popular ON currencies (is_popular);

CREATE INDEX ix_currencies_is_active ON currencies (is_active);

CREATE INDEX ix_currencies_numeric_code ON currencies (numeric_code);

CREATE TABLE group_hidden (
    group_id INTEGER NOT NULL, 
    user_id INTEGER NOT NULL, 
    hidden_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL, 
    CONSTRAINT pk_group_hidden PRIMARY KEY (group_id, user_id), 
    FOREIGN KEY(group_id) REFERENCES groups (id) ON DELETE CASCADE, 
    FOREIGN KEY(user_id) REFERENCES users (id) ON DELETE CASCADE
);

COMMENT ON COLUMN group_hidden.group_id IS 'ID –≥—Ä—É–ø–ø—ã';

COMMENT ON COLUMN group_hidden.user_id IS 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';

CREATE INDEX ix_group_hidden_user_id ON group_hidden (user_id);

CREATE TABLE group_categories (
    group_id INTEGER NOT NULL, 
    category_id INTEGER NOT NULL, 
    created_by INTEGER, 
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL, 
    CONSTRAINT pk_group_categories PRIMARY KEY (group_id, category_id), 
    FOREIGN KEY(group_id) REFERENCES groups (id) ON DELETE CASCADE, 
    FOREIGN KEY(category_id) REFERENCES expense_categories (id) ON DELETE CASCADE, 
    FOREIGN KEY(created_by) REFERENCES users (id) ON DELETE SET NULL
);

CREATE INDEX ix_group_categories_group_id ON group_categories (group_id);

CREATE INDEX ix_group_categories_category_id ON group_categories (category_id);

DELETE FROM group_members gm
    USING (
      SELECT id
      FROM (
        SELECT id,
               ROW_NUMBER() OVER (PARTITION BY group_id, user_id ORDER BY id) AS rn
        FROM group_members
      ) t
      WHERE t.rn > 1
    ) d
    WHERE gm.id = d.id;;

CREATE TEMP TABLE txs_agg AS
    SELECT
      transaction_id,
      user_id,
      COALESCE(SUM(amount), 0) AS amount,
      CASE
        WHEN COUNT(shares) FILTER (WHERE shares IS NOT NULL) = 0 THEN NULL
        ELSE COALESCE(SUM(shares), 0)
      END AS shares
    FROM transaction_shares
    GROUP BY transaction_id, user_id;;

DELETE FROM transaction_shares;;

INSERT INTO transaction_shares (transaction_id, user_id, amount, shares)
    SELECT transaction_id, user_id, amount, shares
    FROM txs_agg;;

ALTER TABLE group_members ADD CONSTRAINT uq_group_members_group_user UNIQUE (group_id, user_id);

ALTER TABLE transaction_shares ADD CONSTRAINT uq_tx_shares_tx_user UNIQUE (transaction_id, user_id);

DO $$
    BEGIN
      IF EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_type='FOREIGN KEY'
          AND table_name='transaction_shares'
          AND constraint_name='transaction_shares_transaction_id_fkey'
      ) THEN
        ALTER TABLE transaction_shares DROP CONSTRAINT transaction_shares_transaction_id_fkey;
      END IF;
    EXCEPTION WHEN others THEN
      -- –Ω–µ —Ä—É—à–∏–º –º–∏–≥—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –∏–º—è –±—ã–ª–æ –¥—Ä—É–≥–∏–º
      NULL;
    END$$;;

ALTER TABLE transaction_shares ADD CONSTRAINT transaction_shares_transaction_id_fkey FOREIGN KEY(transaction_id) REFERENCES transactions (id) ON DELETE CASCADE;

UPDATE alembic_version SET version_num='2025_08_08_groups_v2' WHERE alembic_version.version_num = '7b08661241e1';

-- Running upgrade 2025_08_08_groups_v2 -> 2025_08_15_money_and_indexes

ALTER TABLE transactions
            ALTER COLUMN amount TYPE NUMERIC(12,2)
            USING round((amount)::numeric, 2);

ALTER TABLE transaction_shares
            ALTER COLUMN amount TYPE NUMERIC(12,2)
            USING round((amount)::numeric, 2);

ALTER TABLE transactions ALTER COLUMN currency TYPE VARCHAR(3);

CREATE INDEX ix_tx_group_date ON transactions (group_id, date);

CREATE INDEX ix_txshare_tx ON transaction_shares (transaction_id);

CREATE INDEX ix_txshare_user ON transaction_shares (user_id);

UPDATE alembic_version SET version_num='2025_08_15_money_and_indexes' WHERE alembic_version.version_num = '2025_08_08_groups_v2';

-- Running upgrade 2025_08_15_money_and_indexes -> 2025_08_15_expense_categories_v2

SELECT 1
            FROM information_schema.columns
            WHERE table_schema = current_schema()
              AND table_name = 'expense_categories'
              AND column_name = NULL;

